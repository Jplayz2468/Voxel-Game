<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Multiplayer Voxel Physics - Destructible Players</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        canvas {
            display: block;
            cursor: none;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        
        #debug {
            position: absolute;
            top: 80px;
            left: 20px;
            color: lime;
            font-size: 12px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            max-width: 350px;
            font-family: monospace;
        }
        
        #instructions {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 14px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            line-height: 1.4;
            max-width: 300px;
        }
        
        #connection-status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: red;
            font-size: 14px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
        }
        
        #ping-display {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: lime;
            font-size: 14px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 200;
            text-align: center;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Game Canvas -->
    <canvas id="canvas"></canvas>
    
    <!-- UI Elements -->
    <div id="loading">
        <h2>üéÆ Loading Multiplayer Voxel Game...</h2>
        <p>Connecting to server...</p>
    </div>
    
    <div id="info" class="hidden">FPS: 0</div>
    
    <div id="debug" class="hidden">Connecting to server...</div>
    
    <div id="connection-status" class="hidden">üî¥ Disconnected from server</div>
    
    <div id="ping-display" class="hidden">üì° Ping: --ms</div>
    
    <div id="instructions" class="hidden">
        <strong>üéØ Destructible Voxel Players!</strong><br><br>
        
        <strong>üéÆ Controls:</strong><br>
        WASD: Move around<br>
        Mouse: Look around<br>
        Space: Jump<br>
        Left Click: Shoot voxels<br>
        ESC: Exit mouse control<br><br>
        
        <strong>‚öôÔ∏è Settings:</strong><br>
        T: Toggle Smooth/Raw mode<br>
        C: Toggle Color/Gray mode<br><br>
        
        <strong>üèóÔ∏è Technical Features:</strong><br>
        üß± Players are hollow orange shells<br>
        üé® Greedy meshing for optimization<br>
        üëÅÔ∏è Clean first-person view<br>
        üí• Destructible player bodies<br>
        üéØ Shoot other players apart!<br>
        ‚ö° 50 TPS server physics<br>
        üë• Real-time multiplayer<br><br>
        
        <strong>üé≤ How to Play:</strong><br>
        1. Move around with WASD<br>
        2. Aim with mouse<br>
        3. Shoot other players to knock voxels off<br>
        4. Survive as long as possible!<br>
        5. Open multiple tabs for more players
    </div>

    <!-- Game Scripts -->
    <script type="module">
        // Import all game modules
        import { VoxelClient } from './VoxelClient.js';

        // Global variables
        let client;
        let isGameLoaded = false;

        /**
         * Initializes the game
         */
        async function initializeGame() {
            try {
                console.log('üöÄ Starting Multiplayer Voxel Client...');
                
                // Get canvas and set initial size
                const canvas = document.getElementById('canvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                // Create client
                client = new VoxelClient(canvas);
                
                // Connect to server
                client.connect('ws://localhost:8765');
                
                // Hide loading screen and show UI
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('info').classList.remove('hidden');
                document.getElementById('debug').classList.remove('hidden');
                document.getElementById('connection-status').classList.remove('hidden');
                document.getElementById('ping-display').classList.remove('hidden');
                document.getElementById('instructions').classList.remove('hidden');
                
                // Start game loop
                client.start();
                
                isGameLoaded = true;
                console.log('‚úÖ Game initialized successfully!');
                
            } catch (error) {
                console.error('‚ùå Failed to initialize game:', error);
                document.getElementById('loading').innerHTML = `
                    <h2>‚ùå Failed to Load Game</h2>
                    <p>Error: ${error.message}</p>
                    <button onclick="location.reload()">üîÑ Retry</button>
                `;
            }
        }

        /**
         * Handles window resize
         */
        function handleResize() {
            if (client && isGameLoaded) {
                client.resize();
            }
        }

        /**
         * Handles page visibility changes
         */
        function handleVisibilityChange() {
            if (document.hidden) {
                console.log('üì± Page hidden - game paused');
            } else {
                console.log('üì± Page visible - game resumed');
            }
        }

        /**
         * Cleanup when page is about to unload
         */
        function handleBeforeUnload() {
            if (client) {
                console.log('üëã Page unloading - cleaning up...');
                client.cleanup();
            }
        }

        // Set up event listeners
        window.addEventListener('load', initializeGame);
        window.addEventListener('resize', handleResize);
        window.addEventListener('beforeunload', handleBeforeUnload);
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Expose client to global scope for debugging
        window.voxelClient = () => client;
        window.getGameStats = () => client ? client.getStats() : null;

        // Error handling
        window.addEventListener('error', (event) => {
            console.error('üí• Global error:', event.error);
            
            if (!isGameLoaded) {
                document.getElementById('loading').innerHTML = `
                    <h2>üí• Critical Error</h2>
                    <p>${event.error.message}</p>
                    <button onclick="location.reload()">üîÑ Reload</button>
                `;
            }
        });

        // Performance monitoring
        let performanceLog = [];
        setInterval(() => {
            if (client && isGameLoaded) {
                const stats = client.getStats();
                performanceLog.push({
                    time: Date.now(),
                    fps: stats.performance?.total ? 1000 / stats.performance.total : 0,
                    movingVoxels: stats.movingVoxels,
                    ping: stats.network?.ping || 0
                });
                
                // Keep only last 60 seconds of data
                performanceLog = performanceLog.filter(entry => 
                    Date.now() - entry.time < 60000
                );
            }
        }, 1000);

        // Expose performance data for debugging
        window.getPerformanceLog = () => performanceLog;

        console.log('üì± Client page loaded, waiting for game initialization...');
    </script>
</body>
</html>